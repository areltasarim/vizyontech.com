@using EticaretWebCoreHelper
@using EticaretWebCoreEntity.Enums
@model List<UrunSiralaViewModel>

@{
    ViewData["Title"] = ViewData["Baslik"].ToString();

    var _context = new AppDbContext();

    var controllerValue = HttpContextAccessor.HttpContext.Request.RouteValues["Controller"];

}

@section styles
{
    <link href="~/Admin/Content/Theme/assets/libs/summernote/summernote-bs4.min.css" rel="stylesheet" type="text/css" />
    <link href="~/Admin/Content/Theme/assets/libs/select2/css/select2.min.css" rel="stylesheet" type="text/css" />
    <link href="~/Admin/Content/Theme/assets/libs/bootstrap-datepicker/css/bootstrap-datepicker.min.css" rel="stylesheet">
    <link href="~/Admin/Content/Theme/assets/libs/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css" rel="stylesheet">
    <link href="~/Admin/Content/Theme/assets/libs/bootstrap-touchspin/jquery.bootstrap-touchspin.min.css" rel="stylesheet" />

    <link href="~/lib/jqueryui/themes/base/jquery-ui.min.css" rel="stylesheet" />

    <link href="~/Admin/Content/Theme/ozelcss/custom.css" rel="stylesheet" type="text/css" />
    <style>
        .reorder {
            cursor: grab;
        }

        .toast-success {
            border: 2px solid #1cbb8c !important;
            background-color: rgba(0, 128, 0, 1) !important;
            color: white !important;
            ;
        }
    </style>
}


<partial name="_SayfaBreadcrumb" />
<partial name="_BilgiMesaji" />


<div class="row">
    <div class="col-lg-12">
        <div class="card border border-danger mb-3">
            <select id="categoryFilter" class="form-control select2">
                <option value="">Tüm Kategoriler</option>
                @foreach (var item in _context.KategorilerTranslate.Where(x => x.DilId == 1 && x.KategoriId != 1).ToList())
                {
                    <option value="@string.Join(" > ", item.Kategoriler.ToCategoryTree())">@string.Join(" > ", item.Kategoriler.ToCategoryTree())</option>
                }
            </select>
        </div>
        <div class="card">
            <div class="card-body">
                <table id="urunler" data-pattern="priority-columns" class="table dt-responsive nowrap w-100 display nowrap">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ürün Adı</th>
                            <th>Ürün Kodu</th>
                            <th>Kategori</th>
                            <th>Sıra</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>@item.UrunId</td>
                                <td>@item.UrunKodu @item.UrunAdi</td>
                                <td>@item.UrunKodu</td>
                                <td>@item.KategoriYolu</td>
                                <td>@item.Sira</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <script src="~/Admin/Content/Theme/assets/libs/select2/js/select2.min.js"></script>
    <script src="~/Admin/Content/Theme/assets/js/pages/form-advanced.init.js"></script>

    <!-- DataTable ve RowReorder Eklentisi -->

    <link rel="stylesheet" href="https://cdn.datatables.net/rowreorder/1.4.0/css/rowReorder.dataTables.min.css">

    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/rowreorder/1.4.0/js/dataTables.rowReorder.min.js"></script>

    <script src="~/Admin/Content/Theme/ozel/Custom.js"></script>

    <partial name="_DataTableScriptsPartial" />
    <partial name="_CustomScriptsPartial" />

    <script>
                    $(document).ready(function () {
                        var table = $('#urunler').DataTable({
                            language: {
                                url: "//cdn.datatables.net/plug-ins/1.11.4/i18n/tr.json"
                            },
                            rowReorder: {
                                selector: 'td:first-child',
                                update: false
                            },
                            columnDefs: [
                                { orderable: true, className: 'reorder', targets: 0 },
                                { orderable: false, targets: [1, 2, 3] }, // örnek olarak
                                { type: 'numeric-comma', targets: 4 }     // 4. sütun için özel sıralama türü
                            ],
                            order: [[4, 'asc']]
                        });



            // **Kategoriye Göre Filtreleme**
            $('#categoryFilter').on('change', function () {
                var selectedCategory = $(this).val();
                table.column(3).search(selectedCategory).draw(); // 3. sütun kategori sütunu olmalı
            });

            // **Sürükleme Sonrası Sıralamayı Güncelle**
            table.on('row-reorder', function (e, diff, edit) {
                var reorderedData = [];
                var selectedCategory = $('#categoryFilter').val(); // Seçili kategori

                diff.forEach(function (entry) {
                    var row = $(entry.node);
                    var productId = row.find('td:nth-child(1)').text().trim();
                    var newPosition = entry.newPosition + 1;

                    reorderedData.push({ id: productId, newPosition: newPosition, category: selectedCategory });

                    // **Sadece aynı kategorideki ürünlerin sırasını güncelle**
                    $(row).find("td:nth-child(5)").text(newPosition);
                });

                // Eğer değişiklik varsa veritabanına kaydet
                if (reorderedData.length > 0) {
                    console.log("Gönderilen Veri:", JSON.stringify(reorderedData));

                    $.ajax({
                        url: "/Admin/Urunler/UpdateProductOrderByCategory",
                        type: "POST",
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(reorderedData),
                        success: function (result) {
                            console.log("Sıralama başarıyla güncellendi!", result);

                                toastmesaj(result.MesajDurumu, result.Mesaj, "Başarılı");

                        },
                        error: function (error) {
                            console.error("Sıralama güncelleme hatası!", error);
                        }
                    });
                }
            });
        });



    </script>

}