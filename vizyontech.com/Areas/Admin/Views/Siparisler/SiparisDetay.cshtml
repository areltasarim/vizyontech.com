@inject HelperServis _helperServis
@model Siparisler
@{
    ViewData["Title"] = ViewData["Baslik"].ToString();


    var _context = new AppDbContext();

    var controllerValue = HttpContextAccessor.HttpContext.Request.RouteValues["Controller"];

    var paytrIframeTransaction = _helperServis.GetPaytrIframeTransaction(Model.Id).Result;

    var kupon = _helperServis.GetKuponIndirimTutari(Model.Id).Result;

}

<partial name="_SayfaBreadcrumb" />
<partial name="_BilgiMesaji" />
<div class="row">
    <div class="col-lg-12">
        <form method="post" id="pageForm" asp-area="Admin" asp-controller="@controllerValue" asp-action="DeleteAll">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card border rounded active shipping-address">
                                <h5 class="card-header">
                                    Teslimat Bilgileri
                                </h5>
                                <div class="card-body">
                                    <h5 class="font-size-14">Ad : @Model.TeslimatAd</h5>
                                    <h5 class="font-size-14">Soyad : @Model.TeslimatSoyad</h5>
                                    <h5 class="font-size-14">Telefon : @Model.Telefon</h5>
                                    <h5 class="font-size-14">Email : @Model.Email</h5>
                                    <h5 class="font-size-14">Adres : @Model.TeslimatAdres @Model.TeslimatIlce @Model.TeslimatIl</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="card border rounded active shipping-address">
                                <h5 class="card-header">
                                    Fatura Bilgileri
                                </h5>
                                <div class="card-body">
                                    <h5 class="font-size-14">Ad : @Model.FaturaAd</h5>
                                    <h5 class="font-size-14">Soyad : @Model.FaturaSoyad</h5>
                                    <h5 class="font-size-14">Telefon : @Model.Telefon</h5>
                                    <h5 class="font-size-14">Email : @Model.Email</h5>
                                    <h5 class="font-size-14">Adres : @Model.FaturaAdres @Model.FaturaIlce @Model.FaturaIl</h5>
                                </div>
                            </div>

                        </div>
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-body">
                                    <table id="alternative-page-datatable" data-pattern="priority-columns" class="table dt-responsive nowrap w-100">
                                        <thead>
                                            <tr>
                                                <partial name="_SayfaUstCheckbox" />
                                                <th>Ürün</th>
                                                <th>Ürün Kodu</th>
                                                <th>Birim Fiyatı</th>
                                                <th>Adet</th>
                                                <th>Kdv</th>
                                                <th>Toplam Fiyat</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablolist">
                                            @{
                                                decimal araToplam = 0;
                                                decimal kdvToplam = 0;
                                            }
                                            @foreach (var item in Model.SiparisUrunleri.ToList())
                                            {
                                                araToplam += item.Fiyat * item.Adet;
                                                kdvToplam += item.Kdv;

                                                ViewData["pageName"] = item.SiparisId;

                                                var bayi = _context.Users.Find(item.Siparisler.UyeId);
                                                var fiyatTipi = bayi.IskontoOrani > 0 ? FiyatTipleri.BayiFiyat : FiyatTipleri.ListeFiyat;

                                                <tr>
                                                    <partial name="_SayfaAltCheckbox" for="@item" />
                                                    <td>
                                                        @item.UrunAdi
                                                        <br />
                                                        @foreach (var urunSecenek in item.Siparisler.SiparisUrunSecenekleri.ToList())
                                                        {
                                                            var urunsecenekdeger = urunSecenek.UrunSecenekDegerleri.UrunSecenekDegerleriTranslate.SingleOrDefault(p => p.Diller.DilKodlari.DilKodu == "tr-TR");

                                                            <small>@urunSecenek.SecenekAdi : @urunSecenek.SecenekDegeri</small><br />
                                                        }
                                                    </td>
                                                    <td>
                                                        @item.UrunKodu
                                                    </td>
                                                    <td>
                                                        <span>
                                                            @(_helperServis.FormatCurrency(_helperServis.GetKurTLCeviri(item.Fiyat, fiyatTipi, ParaBirimi.USD).Result, FiyatTipleri.BayiFiyat, ParaBirimi.TRY.ToString(), false))
                                                        </span>
                                                    </td>
                                                    <td>
                                                        @item.Adet
                                                    </td>
                                                    <td>
                                                        @(_helperServis.FormatCurrency(_helperServis.GetKurTLCeviri(item.Kdv, fiyatTipi, ParaBirimi.USD).Result, FiyatTipleri.BayiFiyat, ParaBirimi.TRY.ToString(), false))
                                                    </td>
                                                    <td>
                                                        @(_helperServis.FormatCurrency(_helperServis.GetKurTLCeviri(item.Toplam, fiyatTipi, ParaBirimi.USD).Result, FiyatTipleri.BayiFiyat, ParaBirimi.TRY.ToString(), false))
                                                    </td>
                                                </tr>
                                            }

                                        </tbody>
                                        <tfoot class="bg-light text-end">
                                            <tr>
                                                <td colspan="6"></td>
                                                <td class="text-right"><b>Ara Toplam</b></td>
                                                <td class="text-right">@(_helperServis.FormatCurrency(_helperServis.GetKurTLCeviri(araToplam, FiyatTipleri.BayiFiyat, ParaBirimi.USD).Result, FiyatTipleri.BayiFiyat, ParaBirimi.TRY.ToString(), false))</td>
                                            </tr>
                                            <tr>
                                                <td colspan="6"></td>
                                                <td class="text-right"><b>KDV</b></td>
                                                <td class="text-right">@(_helperServis.FormatCurrency(_helperServis.GetKurTLCeviri(kdvToplam, FiyatTipleri.BayiFiyat, ParaBirimi.USD).Result, FiyatTipleri.BayiFiyat, ParaBirimi.TRY.ToString(), false))</td>
                                            </tr>
                                            @if (kupon != null)
                                            {
                                                <tr>
                                                    <td colspan="6"></td>
                                                    <td class="text-right"><b>Kupon</b></td>
                                                    <td class="text-right">@(_helperServis.FormatCurrency(_helperServis.GetKurTLCeviri(kupon.IndirimTutari, FiyatTipleri.BayiFiyat, ParaBirimi.USD).Result, FiyatTipleri.BayiFiyat, ParaBirimi.TRY.ToString(), false))</td>
                                                </tr>
                                            }
                                            <tr>
                                                <td colspan="6"></td>
                                                <td class="text-right"><b>Kargo Fiyatı</b></td>
                                                <td class="text-right">@Model.KargoUcreti.ToString("C2")</td>
                                            </tr>
                                            <tr>
                                                <td colspan="6"></td>
                                                <td class="text-right"><b>Toplam</b></td>
                                                <td class="text-right">@(_helperServis.FormatCurrency(_helperServis.GetKurTLCeviri(Model.ToplamFiyat, FiyatTipleri.BayiFiyat, ParaBirimi.USD).Result, FiyatTipleri.BayiFiyat, ParaBirimi.TRY.ToString(), false))</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-12">
                            <div class="card">
                                <h5 class="card-header">Sipariş Geçmişi</h5>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-xl-12">
                                            <!-- Nav tabs -->
                                            <ul class="nav nav-tabs" role="tablist">
                                                <li class="nav-item">
                                                    <a class="nav-link active" data-bs-toggle="tab" href="#siparisgecmisi" role="tab">
                                                        <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
                                                        <span class="d-none d-sm-block d-">Sipariş Geçmişi</span>
                                                    </a>
                                                </li>
                                                @if (paytrIframeTransaction != null)
                                                {
                                                    if (paytrIframeTransaction.Status == "success")
                                                    {
                                                        <li class="nav-item">
                                                            <a class="nav-link" data-bs-toggle="tab" href="#paytr" role="tab">
                                                                <span class="d-block d-sm-none"><i class="far fa-user"></i></span>
                                                                <span class="d-none d-sm-block">PayTR Sanal POS - iFrame API</span>
                                                            </a>
                                                        </li>
                                                    }
                                                }

                                            </ul>

                                            <!-- Tab panes -->
                                            <div class="tab-content p-3 text-muted">
                                                <div class="tab-pane active" id="siparisgecmisi" role="tabpanel">
                                                    <p class="mb-0">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <div class="table table-bordered table-responsive">
                                                                    <table class="table mb-0">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Ekleme Tarihi</th>
                                                                                <th>Açıklama</th>
                                                                                <th>Durumu</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            @foreach (var item in await _helperServis.GetSiparisGecmisi(Model.Id))
                                                                            {
                                                                                string odemeaciklama = item.Aciklama;
                                                                                var odemeList = !string.IsNullOrWhiteSpace(odemeaciklama)
                                                                                    ? odemeaciklama.Split(new[] { '\n' }, StringSplitOptions.RemoveEmptyEntries)
                                                                                    : Array.Empty<string>(); // Daha temiz bir yol ile boş liste oluşturuldu
                                                                                <tr>
                                                                                    <td>@item.EklenmeTarihi</td>
                                                                                    <td>
                                                                                        <ul style="list-style:none; padding-left:0 !important">
                                                                                            @foreach (var odemeitem in odemeList)
                                                                                            {
                                                                                                <li>@odemeitem</li>
                                                                                            }
                                                                                        </ul>
                                                                                    </td>
                                                                                    <td>@(item.SiparisDurumlari.SiparisDurumlariTranslate.SingleOrDefault(x=> x.Diller.DilKodlari.DilKodu == _helperServis.GetCurrentCulture()).SiparisDurumu)</td>
                                                                                </tr>
                                                                            }
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </p>
                                                </div>
                                                @if (paytrIframeTransaction != null)
                                                {
                                                    <div class="tab-pane" id="paytr" role="tabpanel">
                                                        <p class="mb-0">
                                                            <div class="card">
                                                                <div class="card-body">
                                                                    <div class="table-responsive">
                                                                        <table class="table mb-0">
                                                                            <thead>
                                                                                <tr>
                                                                                    <th>PayTR Sipariş No</th>
                                                                                    <th>Toplam</th>
                                                                                    <th>Toplam Ödenen</th>
                                                                                    <th>Tarih</th>
                                                                                </tr>
                                                                            </thead>
                                                                            <tbody>
                                                                                <tr>
                                                                                    <td>@paytrIframeTransaction.MerchantOid</td>
                                                                                    <td>@paytrIframeTransaction.ToplamFiyat.ToString("C2")</td>
                                                                                    <td>@paytrIframeTransaction.OdenenTutar.ToString("C2")</td>
                                                                                    <td>@paytrIframeTransaction.EklemeTarihi</td>
                                                                                </tr>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </p>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>



<partial name="_RemoveModal" />
@section scripts
{
    <partial name="_DataTableScriptsPartial" />

    <partial name="_CustomScriptsPartial" />

}